---
title: JS变量的创建机制
layout: post
category: 前端技术
tags:
  - web前端
  - JavaScript
date: 2018-07-04 10:44:57
update: 2018-08-05 20:57:57
comments: true
copyright: true
---

## 前言
JS 怎么创建变量？相信大家都会：
``` javascript
var a;
function b(){}
```

那么它们具体存储在哪里，又是怎么运行的呢？

这次，就聊一聊 JS 的堆栈内存和变量的创建机制。（这里只介绍 ES5 的机制）

<!-- more -->
## 1. 堆栈内存
在了解变量创建机制之前，先来了解一下变量的存储空间。

存储空间分为栈内存和堆内存。

栈内存：作用域
- 提供一个供 JS 代码自上而下执行的环境（代码都是在栈内存中执行的）
- 存储基本类型值。由于基本类型比较简单，它们都是直接在栈内存中开辟一个位置，直接把值存储进去的

堆内存：引用值对应的空间
- 对象：键值对
- 函数：代码字符串

由于引用类型的值可能过于复杂，所以需要另外开辟空间来存储，而变量中存储的只是指向这个空间的地址。

## 2. 变量的创建

（1）创建作用域
当浏览器（内核/引擎）渲染和解析 JS 代码的时候，会提供一个供 JS 代码运行的环境，这个环境称为“全局作用域”（global / window scope），是一个栈内存

（2）进行变量提升
将在作用域中使用 var / function 声明的变量进行提升。其中
- var 声明的变量只提升声明，不定义
- function 声明的变量，既提升声明，也提升定义

所以，函数在当前作用域的任何地方都可以使用。

（2）代码自上而下执行
基本数据类型的值会存储在当前作用域下，以 `var a = 12` 为例
- 首先在当前作用域中声明一个变量 a（这一步会在变量提升阶段完成，执行时会忽略这个声明）
- 然后开辟一个空间存储值 12
- 最后让声明的变量与存储的值进行关联（就是赋值操作，也叫做定义）

基本数据类型（也叫做值类型），是按照值来操作的：把原有的值赋值一份放到新的空间或者位置上，和原来的值没有关系

引用数据类型的值，我们需要开辟一个新的空间（理解为仓库），把内容存储到这个空间中
- 首先声明一个变量（同样，这一步是在变量提升阶段完成，执行时会忽略这个声明）
- 然后开辟一个新的内存空间，把对象中的键值对依次存储起来（此空间有个 16 进制的地址）
- 让变量与空间地址关联起来（把空间地址赋值给变量）

``` javascript
var obj = {
  n: 10,
  m: obj.n * 10
  //=> Uncaught TypeError: Cannot read property 'n' of undefined
};
console.log(obj.m);
```
原因分析
1. 形成一个全局作用域（栈内存）
2. 代码自上而下执行
 - 首先开辟一个新的堆内存，把键值对存储到对内存中 `n: 10`, `m: obj.n * 10`
 - 此时堆内存信息还没有存储完成，空间地址还没有与变量 `obj` 关联，此时的 `obj` 是 `undefined`，`obj.n <=> undefined.n`，所以报错

``` javascript
var obj = {
  n: 10
};
obj.m = obj.n * 10; // 此时的 obj 已经有值了
console.log(obj.m); //=> 100
```

引用类型不是按照值来操作，它操作的是空间的地址：把原有空间地址赋值给新的变量，但是原来的空间没有被克隆，还是同一个空间，这样就会出现多个变量关联的是相同的空间，相互之间就会存在影响。

``` javascript
var arr1 = [3, 4];
var arr2 = arr1;
arr2[0] = 1;
arr2 = [4, 5];
arr2[1] = 2;
arr1[1] = 0;
console.log(arr1, arr2); //=> 1, 0, 4, 2
```

原因分析：
1. 数组也是对象，属于引用类型，会开辟一个新的堆内存保存 `[3,4]`
2. 往下，`arr2 = arr1`，此时两个变量同时保存一个堆内存的地址
3. 改变 arr2 会反映到 arr1，此时 arr1: `[1,4]` arr2: `[1,4]`
4. 新开辟一个堆内存，保存 `[4,5]`，然后再把地址赋值给 arr2
5. 此时两个变量关联的内存不再一样，对其的操作不再相互影响，此时 arr1: `[1,4]` arr2:`[4,5]`
6. 再次赋值后，arr1: `[1,0]` arr2: `[4,2]`

<Quote>生命的意义不仅是活着，而是我们给别人的生命带来了何种不同。</Quote>
